<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.grid.dao.PatientDao">

    <resultMap id="patientMap" type="com.grid.entity.PatientBean">
        <result column="pid" property="pid"/>
        <result column="card_id" property="cardId"/>
        <result column="name" property="name"/>
        <result column="birthday" property="birthday"/>
        <result column="mphone" property="mphone"/>
        <result column="gender" property="gender"/>
        <result column="balance" property="balance"/>
        <result column="isdel" property="isdel"/>
        <result column="remark" property="remark"/>
        <result column="create_date" property="createDate"/>
    </resultMap>

    <sql id="fields">
        pid, card_id, name, birthday, mphone, gender, balance, isdel, remark, create_date
    </sql>

    <select id="getPatientByParam" parameterType="com.grid.entity.QueryPatientParamBean" resultMap="patientMap">
        SELECT <include refid="fields"/>
        FROM patient
        <where>
            <if test="pid != null">AND pid LIKE '%${pid}%'</if>
            <if test="cardId != null">AND card_id LIKE '%${cardId}%'</if>
            <if test="name != null">AND name LIKE '%${name}%'</if>
            <if test="age != null">AND year(birthday) =  YEAR(Now()) - #{age}</if>
            <if test="mphone != null">AND mphone LIKE '%${mphone}%'</if>
            <if test="gender != null">AND gender LIKE '%${gender}%'</if>
            <if test="balanceFrom != null">AND balance <![CDATA[>=]]> #{balanceFrom}</if>
            <if test="balanceTo != null">AND balance <![CDATA[<=]]> #{balanceTo}</if>
            AND isdel = "0"
        </where>
        ORDER BY CONVERT( ${sort} USING gbk ) COLLATE gbk_chinese_ci ${order}
        limit #{startnum}, #{getrows}
    </select>

    <select id="getPatientByParamCount" parameterType="com.grid.entity.QueryPatientParamBean" resultType="int">
        SELECT COUNT(*)
        FROM patient
        <where>
            <if test="pid != null">AND pid LIKE '%${pid}%'</if>
            <if test="cardId != null">AND card_id LIKE '%${cardId}%'</if>
            <if test="name != null">AND name LIKE '%${name}%'</if>
            <if test="age != null">AND year(birthday) =  YEAR(Now()) - #{age}</if>
            <if test="mphone != null">AND mphone LIKE '%${mphone}%'</if>
            <if test="gender != null">AND gender LIKE '%${gender}%'</if>
            <if test="balanceFrom != null">AND balance <![CDATA[>=]]> #{balanceFrom}</if>
            <if test="balanceTo != null">AND balance <![CDATA[<=]]> #{balanceTo}</if>
            AND isdel = "0"
        </where>
    </select>

    <select id="getPatientById" resultMap="patientMap">
        SELECT <include refid="fields"/>
        FROM patient
        WHERE pid = #{pid}
    </select>

    <insert id="insert" parameterType="com.grid.entity.PatientBean">
        INSERT INTO patient(<include refid="fields"/> )
        VALUES (#{pid}, #{cardId}, #{name}, #{birthday}, #{mphone}, #{gender}, #{balance}, "0", #{remark}, Now())
    </insert>

    <update id="update" parameterType="com.grid.entity.PatientBean">
        UPDATE patient
        SET card_id = #{cardId}, name = #{name}, birthday = #{birthday},
        mphone = #{mphone}, gender = #{gender}, balance = #{balance}, remark = #{remark}
        WHERE pid = #{pid}
    </update>

    <delete id="deletePatientById">
        UPDATE patient
        SET isdel = "1"
        WHERE pid = #{pid}
    </delete>

    <update id="charge" parameterType="com.grid.entity.ChargeBean">
        UPDATE patient
        SET balance = balance - #{realPrice}
        WHERE pid = #{pid}
    </update>

    <update id="topup" parameterType="com.grid.entity.TopupBean">
        UPDATE patient
        SET balance = balance + #{amount}
        WHERE pid = #{pid}
    </update>

    <select id="getTradeRecordByParam" parameterType="com.grid.entity.QueryTradeRecordBean" resultType="com.grid.entity.TradeRecordBean">
        SELECT * FROM
        (SELECT
        c.cid as tradeId,
        c.trade_type as tradeType,
        c.pid, p.name as patientName, p.card_id as patientCardId, p.mphone as patientPhone,
        c.iid, i.name as itemName, c.original_price as originalPrice, c.discount,
        c.real_price as amount, c.after_balance as afterBalance,
        c.uid, u.name as userName,
        c.create_time as createTime, c.remark
        FROM charge c
        LEFT JOIN patient p on c.pid = p.pid
        LEFT JOIN user u on c.uid = u.uid
        LEFT JOIN item i on c.iid = i.iid
        UNION
        SELECT
        t.tip as tradeId,
        t.trade_type as tradeType,
        t.pid, p.name as patientName, p.card_id as patientCardId, p.mphone as patientPhone,
        t.iid, i.name as itemName, t.original_price as originalPrice, t.discount,
        t.amount, t.after_balance as afterBalance,
        t.uid, u.name as userName,
        t.create_time as createTime, t.remark
        FROM topup t
        LEFT JOIN patient p on t.pid = p.pid
        LEFT JOIN user u on t.uid = u.uid
        LEFT JOIN item i on t.iid = i.iid) AS total
        <where>
            <if test="tradeId != null and tradeId != ''">AND tradeId = #{tradeId}</if>
            <if test="tradeType != null and tradeType != ''">AND tradeType LIKE '%${tradeType}%'</if>
            <if test="pid != null and pid != ''">AND pid LIKE '%${pid}%'</if>
            <if test="patientName != null and patientName != ''">AND patientName LIKE '%${patientName}%'</if>
            <if test="patientCardId != null and patientCardId != ''">AND patientCardId LIKE '%${patientCardId}%'</if>
            <if test="patientPhone != null and patientPhone != ''">AND patientPhone LIKE '%${patientPhone}%'</if>
            <if test="amount != null and amount != ''">AND amount LIKE '%${amount}%'</if>
            <if test="afterBalance != null and afterBalance != ''">AND afterBalance LIKE '%${afterBalance}%'</if>
            <if test="uid != null and uid != ''">AND uid LIKE '%${uid}%'</if>
            <if test="userName != null and userName != ''">AND userName LIKE '%${userName}%'</if>
            <if test="createTimeFrom != null and createTimeFrom != ''">AND createTime <![CDATA[>=]]> #{createTimeFrom}</if>
            <if test="createTimeTo != null and createTimeTo != ''">AND createTime <![CDATA[<=]]> #{createTimeTo}</if>
        </where>
        ORDER BY CONVERT( ${sort} USING gbk ) COLLATE gbk_chinese_ci ${order}
        limit #{startnum}, #{getrows}
    </select>

    <select id="getTradeRecordCountByParam" parameterType="com.grid.entity.QueryTradeRecordBean" resultType="int">
        SELECT COUNT(*) FROM
        (SELECT
        c.trade_type as tradeType,
        c.pid, p.name as patientName, p.card_id as patientCardId, p.mphone as patientPhone,
        c.real_price as amount, c.after_balance as afterBalance,
        c.uid, u.name as userName,
        c.create_time as createTime, c.remark
        FROM charge c
        LEFT JOIN patient p on c.pid = p.pid
        LEFT JOIN user u on c.uid = u.uid
        UNION
        SELECT
        t.trade_type as tradeType,
        t.pid, p.name as patientName, p.card_id as patientCardId, p.mphone as patientPhone,
        t.amount, t.after_balance as afterBalance,
        t.uid, u.name as userName,
        t.create_time as createTime, t.remark
        FROM topup t
        LEFT JOIN patient p on t.pid = p.pid
        LEFT JOIN user u on t.uid = u.uid) AS total
        <where>
            <if test="tradeId != null and tradeId != ''">AND tradeId = #{tradeId}</if>
            <if test="tradeType != null and tradeType != ''">AND tradeType LIKE '%${tradeType}%'</if>
            <if test="pid != null and pid != ''">AND pid LIKE '%${pid}%'</if>
            <if test="patientName != null and patientName != ''">AND patientName LIKE '%${patientName}%'</if>
            <if test="patientCardId != null and patientCardId != ''">AND patientCardId LIKE '%${patientCardId}%'</if>
            <if test="patientPhone != null and patientPhone != ''">AND patientPhone LIKE '%${patientPhone}%'</if>
            <if test="amount != null and amount != ''">AND amount LIKE '%${amount}%'</if>
            <if test="afterBalance != null and afterBalance != ''">AND afterBalance LIKE '%${afterBalance}%'</if>
            <if test="uid != null and uid != ''">AND uid LIKE '%${uid}%'</if>
            <if test="userName != null and userName != ''">AND userName LIKE '%${userName}%'</if>
            <if test="createTimeFrom != null and createTimeFrom != ''">AND createTime <![CDATA[>=]]> #{createTimeFrom}</if>
            <if test="createTimeTo != null and createTimeTo != ''">AND createTime <![CDATA[<=]]> #{createTimeTo}</if>
        </where>
    </select>

</mapper>